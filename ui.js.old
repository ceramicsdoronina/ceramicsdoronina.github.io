// ui.js
(function () {

  function initNavbarAutoClose() {
    document.addEventListener("click", (e) => {
      if (!document.body.classList.contains("nav-open")) return;
  
      const clickedToggle = e.target.closest("#nav-toggle, .nav-toggle-btn");
      const clickedInsideMenu = e.target.closest("header nav ul");
  
      // Non chiudere se sto cliccando sul bottone hamburger o dentro al menu
      if (clickedToggle || clickedInsideMenu) return;
  
      // Chiudi in tutti gli altri casi (fuori header + dentro header ma fuori menu)
      document.body.classList.remove("nav-open");
    });
  
    // Chiudi anche quando clicchi su una voce del menu
    document.addEventListener("click", (e) => {
      const link = e.target.closest("header nav a");
      if (!link) return;
      document.body.classList.remove("nav-open");
    });
  
    // ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.body.classList.remove("nav-open");
      }
    });
  }

  function initNavbarToggle() {
    const body = document.body;
    const toggle = document.querySelector("header #nav-toggle") ||
               document.querySelector("header .nav-toggle-btn");
    const navUl = document.querySelector("header nav ul");
  
    console.log("ðŸ” [UI] Inizializzazione navbar toggle");
    console.log("ðŸ” [UI] Toggle button trovato:", !!toggle);
    console.log("ðŸ” [UI] Nav ul trovato:", !!navUl);
  
    if (!toggle) {
      console.warn("âŒ [UI] Toggle button non trovato");
      return;
    }
    
    if (!navUl) {
      console.warn("âŒ [UI] Nav ul non trovato");
      return;
    }
  
    // Evita listener duplicati
    if (toggle.dataset.bound === "1") {
      console.log("âœ… [UI] Toggle giÃ  inizializzato");
      return;
    }
    toggle.dataset.bound = "1";
  
    toggle.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const wasOpen = body.classList.contains("nav-open");
      body.classList.toggle("nav-open");
      const isOpen = body.classList.contains("nav-open");
      
      console.log("ðŸ” [UI] Toggle cliccato");
      console.log("ðŸ” [UI] Era aperto:", wasOpen);
      console.log("ðŸ” [UI] Ora aperto:", isOpen);
      console.log("ðŸ” [UI] Body classes:", body.className);
      console.log("ðŸ” [UI] Nav ul display:", window.getComputedStyle(navUl).display);
      
      toggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
    });
    
    console.log("âœ… [UI] Navbar toggle inizializzato");
  }

  function setViewMode(mode) {
    if (mode === "mobile") document.body.classList.add("mobile-view");
    else document.body.classList.remove("mobile-view");
    localStorage.setItem("cd_view", mode);
  }

  function initViewToggle() {
    const saved = localStorage.getItem("cd_view");
    if (saved === "mobile" || saved === "desktop") {
      setViewMode(saved);
    }

    const btn = document.getElementById("view-toggle-btn");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const now = document.body.classList.contains("mobile-view") ? "desktop" : "mobile";
      setViewMode(now);
      btn.textContent = now === "mobile" ? "Desktop" : "Mobile";
    });
  }

  function toStorefrontVariantId(id) {
    const s = String(id || "").trim();
  
    // giÃ  gid
    if (s.startsWith("gid://shopify/ProductVariant/")) return s;
  
    // giÃ  base64 (tipicamente Z2lkOi8v...)
    if (s.startsWith("Z2lkOi8v")) return s;
  
    // numero -> gid base64
    return btoa(`gid://shopify/ProductVariant/${s}`);
  }

  async function waitForCartModel(cart, timeoutMs = 4000) {
    const start = Date.now();
    while (Date.now() - start < timeoutMs) {
      if (cart && cart.model) return true;
      await new Promise(r => setTimeout(r, 50));
    }
    return false;
  }


  window.CD = window.CD || {};
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHOPIFY CART (Buy Button SDK)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  window.CD.shop = {
    ready: false,
    ui: null,
    cart: null,

    async init() {
      if (this.ready) return;

      if (typeof ShopifyBuy === "undefined" || !ShopifyBuy.buildClient) {
        console.error("âŒ [SHOP] ShopifyBuy non disponibile. Hai caricato buy-button-storefront.min.js?");
        return;
      }

      const client = ShopifyBuy.buildClient({
        domain: "ceramicsdoronina.myshopify.com",
        storefrontAccessToken: "de1ab17005ca54e662d4c86543f523cd"
      });

      this.ui = await ShopifyBuy.UI.onReady(client);
      console.log("ðŸ§ª [SHOP] Test storefront token...");
      
      try {
        const q = await client.product.fetchAll(1);
        console.log("âœ… [SHOP] Token OK, prodotti visibili:", q?.length);
        console.log("ðŸ§ª [SHOP] Test checkout write...");
    
        try {
          const checkout = await client.checkout.create();
          console.log("âœ… [SHOP] Checkout creato correttamente:", checkout.id);
        } catch (err) {
          console.error(
            "âŒ [SHOP] Checkout NON creato â†’ manca unauthenticated_write_checkouts",
            err
          );
          return; // IMPORTANTISSIMO: fermiamo init()
        }
      } catch (e) {
        console.error("âŒ [SHOP] Token/permessi NON OK:", e);
        return;
      }

      // crea il carrello (drawer)
      const cartNode = document.getElementById("shopify-cart");
      if (!cartNode) {
        console.error("âŒ [SHOP] #shopify-cart non trovato nel DOM");
        return;
      }
      
      try {

        // pulizia nodo (evita stati strani)
        cartNode.innerHTML = "";
        
        // 1) prova con node
        let cartComp;
        try {
          cartComp = this.ui.createComponent("cart", {
            node: cartNode,
            options: { cart: { startOpen: false } }
          });
        
          if (cartComp && typeof cartComp.then === "function") {
            cartComp = await cartComp;
          }
        } catch (e) {
          console.error("âŒ [SHOP] createComponent('cart', node) FAILED:", e);
        }
        
        // 2) se non torna nulla, prova senza node (alcune versioni vogliono cosÃ¬)
        if (!cartComp) {
          try {
            cartComp = this.ui.createComponent("cart", {
              options: { cart: { startOpen: false } }
            });
        
            if (cartComp && typeof cartComp.then === "function") {
              cartComp = await cartComp;
            }
          } catch (e) {
            console.error("âŒ [SHOP] createComponent('cart') FAILED:", e);
          }
        }
        
        // 3) se ancora nulla, recupera dal registry interno UI
        if (!cartComp) {
          const maybe = this.ui?.components?.cart?.[0];
          if (maybe) {
            console.warn("âš ï¸ [SHOP] cartComp undefined, ma trovato in ui.components.cart[0]");
            cartComp = maybe;
          }
        }
        
        this.cart = cartComp;
        
        if (!this.cart) {
          console.error("âŒ [SHOP] Cart ancora null dopo fallback. UI components:", this.ui?.components);
          return;
        }

        // attende che il cart sia realmente inizializzato (model pronto)
        const okModel = await waitForCartModel(this.cart, 4000);
        if (!okModel) {
          console.error("âŒ [SHOP] Cart creato ma model non pronto (timeout).");
          return;
        }
        
        /*
         let cartComp = this.ui.createComponent("cart", {
           node: cartNode,
           options: { cart: { startOpen: true } }
         });
         
         // se Ã¨ una Promise, aspetta
         if (cartComp && typeof cartComp.then === "function") {
           cartComp = await cartComp;
         }
         
         this.cart = cartComp;
         
         if (!this.cart) {
           console.error("âŒ [SHOP] createComponent('cart') ha restituito null/undefined");
           return;
         }
*/
      } catch (e) {
        console.error("âŒ [SHOP] createComponent('cart') FAILED:", e);
        return;
      }

      this.ready = true;
      console.log("âœ… [SHOP] Shopify cart pronto");
    },

    async addVariant(variantId, qty = 1) {
      await this.init();
      if (!this.cart) {
        console.error("âŒ [SHOP] cart non inizializzato");
        return;
      }
      const okModel = await waitForCartModel(this.cart, 4000);
      if (!okModel) {
        console.error("âŒ [SHOP] Cart model non pronto: salto add-to-cart");
        return null;
      }
    
      const storefrontId = toStorefrontVariantId(variantId);
      console.log("ðŸ§¾ [SHOP] add-to-cart", JSON.stringify({ variantId, storefrontId, qty }));
    
      try {
        const res = await this.cart.addVariantToCart(storefrontId, qty);
    
        // DEBUG: prova a leggere quante lineItems ci sono
        const lineCount =
          this.cart?.model?.lineItems?.length ??
          this.cart?.checkout?.lineItems?.length ??
          null;
    
        console.log("âœ… [SHOP] addVariantToCart result:", res);
        console.log("ðŸ§¾ [SHOP] line items count:", lineCount);
    
        if (this.cart.open) this.cart.open();
        return res;
      } catch (err) {
        console.error("âŒ [SHOP] addVariantToCart FAILED:", err);
        throw err;
      }

    }

  };

  function initCartOpenButton() {
    const btn = document.getElementById("cart-open-btn");
    if (!btn) return;
  
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      await window.CD.shop.init();
      if (window.CD.shop.cart?.open) window.CD.shop.cart.open();
    });
  }

  window.CD.ui = {
    initNavbarToggle,
    initNavbarAutoClose,
    initViewToggle,
    initCartOpenButton
  };
})();

// --- Likes (globali) ---
(function () {
  const LIKE_KEY = "cd_likes_v1";

  function getLikes() {
    try { return new Set(JSON.parse(localStorage.getItem(LIKE_KEY) || "[]")); }
    catch { return new Set(); }
  }

  function setLikes(set) {
    localStorage.setItem(LIKE_KEY, JSON.stringify([...set]));
  }

  function toggleLike(key) {
    const likes = getLikes();
    if (likes.has(key)) likes.delete(key);
    else likes.add(key);
    setLikes(likes);
    return likes;
  }

  function isLiked(key) {
    return getLikes().has(key);
  }

  window.CD = window.CD || {};
  window.CD.likes = { getLikes, toggleLike, isLiked };
})();

document.addEventListener("click", (e) => {
  const btn = e.target.closest("[data-like-key]");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const key = btn.getAttribute("data-like-key");
  const likes = window.CD.likes.toggleLike(key);
  btn.textContent = likes.has(key) ? "â™¥" : "â™¡";

  // se hai una sezione preferiti, aggiornala
  window.CD?.likedSection?.render?.();
});

