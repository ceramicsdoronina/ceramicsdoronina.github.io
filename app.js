/* ============================================================
   LINGUE – dizionario di traduzione
============================================================ */

const messages = {
  ru: {
    nav: {
      home: "Главная",
      about: "О бренде",
      catalogue: "Каталог",
      workshops: "Мастер-классы",
      giftcards:"Подарочные сертификаты",
      contact: "Контакты"
    },
    hero: {
      tagline: "Тактильная интерьерная керамика с бисерной вышивкой, которая превратит ваш дом в место силы и вдохновения."
    },
    about: {
      title: "О бренде",
      intro1: "Меня зовут Анна, и я создаю интерьерную керамику как объект искусства, который поддерживает, вдохновляет и становится частью вашего личного пространства силы.",
      intro2: "Я верю, что предметы, с которыми мы живём, влияют на наше состояние.",
      btnCatalogue: "Каталог",
      btnWorkshops: "Мастер-классы",
      btnGiftCards: "Подарочные сертификаты",
      text1: "Мои вазы — это не просто формы, а предметы, которые меняют атмосферу дома, заряжают энергией и становятся визуальной опорой.",
      text2: "В каждой работе — высокотемпературная глина, тактильные текстуры, бисерная вышивка и сочетание неровных форм с ощущением роскоши."
    },
    catalogue: {
      title: "Каталог",
      lead: "Каждое изделие — это уникальная эмоция для вашего пространства.",
      viewPhotos: "Смотреть фото",
      spec: {
        height: "Высота",
        diameter: "Диаметр",
        material: "Материал",
        technique: "Техника",
        finish: "Покрытие"
      }
    },
    detail: {
      description: "Описание",
      characteristics: "Характеристики",
      delivery: "Доставка",
      deliveryText: "Мы бережно упаковываем и отправляем изделия по всему миру из Лигурии."
    },
    status: {
      sold: "Продано"
    },
    contact: {
      title: "Контакты",
      address: "Адрес мастерской:"
    },
    footer: {
      made: "Сайт создан на GitHub Pages"
    },
    workshops: {
      title: "Мастер-классы",
      lead: "Камерные занятия по работе с глиной в мастерской в Генуе.",
      item1: "Базовые техники ручной лепки и работа с высокотемпературной глиной.",
      item2: "Создание вазы или интерьерного объекта в духе ваби-саби.",
      item3: "Небольшие группы и внимательное сопровождение каждого участника.",
      note: "Чтобы узнать расписание ближайших мастер-классов или организовать частное занятие, напишите мне.",
      cta: "Написать для записи"
    },
    giftcards: {
      title: "Подарочные сертификаты",
      lead: "Нежный способ подарить керамику или мастер-класс: человек сам выбирает то, что ему откликается.",
      item1: "Гибкий формат: сертификат на определённую сумму или на конкретное изделие.",
      item2: "Возможность подарить участие в мастер-классе в мастерской в Генуе.",
      item3: "Цифровой сертификат с персональным посланием, отправленный по e-mail.",
      note: "Напишите мне, чтобы подобрать сумму, формат и текст подарка.",
      cta: "Написать о подарочном сертификате"
    }
  },

  it: {
    nav: {
      home: "Home",
      about: "Il brand",
      catalogue: "Catalogo",
      workshops: "Masterclass",
      giftcards:"Gift Card",
      contact: "Contatti"
    },
    hero: {
      tagline: "Ceramica tattile da interno con ricami di perle che trasforma la tua casa in un luogo di forza e ispirazione."
    },
    about: {
      title: "Il brand",
      intro1: "Mi chiamo Anna e creo ceramiche d’interni come oggetti d’arte che sostengono, ispirano e diventano parte del tuo spazio personale di forza.",
      intro2: "Credo che gli oggetti con cui viviamo influenzino profondamente il nostro stato interiore.",
      btnCatalogue: "Catalogo",
      btnWorkshops: "Masterclass",
      btnGiftCards: "Gift Card",
      text1: "I miei vasi non sono solo forme, ma oggetti che trasformano l’atmosfera della casa e creano un punto focale visivo.",
      text2: "In ogni pezzo ci sono argille ad alta temperatura, texture tattili, ricami di perle e l’unione di forme imperfette con una sensazione di lusso."
    },
    catalogue: {
      title: "Catalogo",
      lead: "Ogni pezzo è un’emozione unica per il tuo spazio.",
      viewPhotos: "Vedi foto",
      spec: {
        height: "Altezza",
        diameter: "Diametro",
        material: "Materiale",
        technique: "Tecnica",
        finish: "Finitura"
      }
    },
    detail: {
      description: "Descrizione",
      characteristics: "Caratteristiche",
      delivery: "Spedizione",
      deliveryText: "Spediamo in tutto il mondo dalla Liguria, con imballaggio protettivo."
    },
    status: {
      sold: "Venduto"
    },
    contact: {
      title: "Contatti",
      address: "Studio:"
    },
    footer: {
      made: "Realizzato con GitHub Pages"
    },
    workshops: {
      title: "Masterclass",
      lead: "Incontri dal vivo e piccoli gruppi di lavoro con l’argilla nel laboratorio a Genova.",
      item1: "Tecniche base di modellazione a mano e uso di argille ad alta temperatura.",
      item2: "Creazione di un vaso o oggetto per interni nello stile wabi-sabi.",
      item3: "Gruppi raccolti, attenzione personale ad ogni partecipante.",
      note: "Per il calendario aggiornato o per organizzare una masterclass privata, scrivimi.",
      cta: "Scrivi per iscriverti"
    },
    giftcards: {
      title: "Gift Card",
      lead: "Un modo delicato per regalare arte e presenza: il destinatario sceglie il vaso o il workshop che sente più suo.",
      item1: "Formati flessibili: voucher per un importo specifico o per un singolo pezzo.",
      item2: "Possibilità di abbinare la gift card a una masterclass nel laboratorio a Genova.",
      item3: "Gift card digitale con messaggio personalizzato, inviata via email.",
      note: "Scrivimi per scegliere insieme l’importo, la formula e il testo personale del tuo regalo.",
      cta: "Scrivi per una Gift Card"
    }
  },

  en: {
    nav: {
      home: "Home",
      about: "About",
      catalogue: "Catalogue",
      workshops: "Workshops",
      giftcards:"Gift Cards",
      contact: "Contact"
    },
    hero: {
      tagline: "Tactile interior ceramics with bead embroidery that turns your home into a place of strength and inspiration."
    },
    about: {
      title: "About the brand",
      intro1: "My name is Anna and I create interior ceramics as art objects that support, inspire, and become part of your personal space of strength.",
      intro2: "I believe the objects we live with shape our inner state.",
      btnCatalogue: "Catalogue",
      btnWorkshops: "Workshops",
      btnGiftCards: "Gift Cards",
      text1: "My vases are not just shapes, but pieces that transform the atmosphere of your home.",
      text2: "Each work combines high-fire clays, tactile textures, bead embroidery and a sense of quiet luxury."
    },
    catalogue: {
      title: "Catalogue",
      lead: "Each piece is a unique emotion for your space.",
      viewPhotos: "View photos",
      spec: {
        height: "Height",
        diameter: "Diameter",
        material: "Material",
        technique: "Technique",
        finish: "Finish"
      }
    },
    detail: {
      description: "Description",
      characteristics: "Characteristics",
      delivery: "Shipping",
      deliveryText: "We carefully pack and ship worldwide from Liguria, Italy."
    },
    status: {
      sold: "Sold out"
    },
    contact: {
      title: "Contact",
      address: "Studio address:"
    },
    footer: {
      made: "Made with GitHub Pages"
    },
    workshops: {
      title: "Workshops",
      lead: "Intimate ceramic workshops in the studio in Genoa, in small groups.",
      item1: "Fundamentals of hand-building and working with high-fire clay.",
      item2: "Creating a vase or interior object in a wabi-sabi inspired style.",
      item3: "Small groups and individual guidance for each participant.",
      note: "For the updated schedule or to organise a private workshop, feel free to contact me.",
      cta: "Write to join"
    },
    giftcards: {
      title: "Gift Cards",
      lead: "A gentle way to gift art and presence: the recipient chooses the vase or workshop that resonates most.",
      item1: "Flexible formats: a voucher for a specific amount or for a particular piece.",
      item2: "You can also gift a place in a workshop in the studio in Genoa.",
      item3: "Digital gift card with a personalised message, sent via email.",
      note: "Write to me to define the amount, format, and personal text for your gift.",
      cta: "Write about a Gift Card"
    }
  }
};

let currentLang = null;

/* ============================================================
   TRADUZIONI
============================================================ */

function applyTranslations(lang){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const keys = el.dataset.i18n.split(".");
    let value = messages[lang];
    for (const k of keys){
      if (value && value[k] != null) value = value[k];
    }
    if (typeof value === "string"){
      el.textContent = value;
    }
  });
}

function getInitialLang(){
  const saved = localStorage.getItem("lang");
  if (saved && messages[saved]) return saved;
  const browser = (navigator.language || "ru").slice(0,2);
  if (messages[browser]) return browser;
  return "ru";
}

function setLang(lang){
  if (!messages[lang]) lang = "ru";
  currentLang = lang;
  localStorage.setItem("lang", lang);
  document.documentElement.lang = lang;

  const sel = document.getElementById("language-selector");
  if (sel) sel.value = lang;

  applyTranslations(lang);
  buildCatalogue();  // ricostruisce il catalogo nella nuova lingua
}

/* ============================================================
   MENU MOBILE
============================================================ */

function initMobileNav(){
  const btn = document.getElementById("nav-toggle");
  if (!btn) return;

  btn.addEventListener("click", ()=>{
    document.body.classList.toggle("nav-open");
  });

  document.querySelectorAll("nav a").forEach(a=>{
    a.addEventListener("click", ()=>{
      document.body.classList.remove("nav-open");
    });
  });
}

/* ============================================================
   TOGGLE DESKTOP / MOBILE VIEW
============================================================ */

function initViewToggle(){
  const btn = document.getElementById("view-toggle-btn");
  if (!btn) return;

  const syncLabel = () => {
    btn.textContent = document.body.classList.contains("mobile-view")
      ? "Desktop"
      : "Mobile";
  };

  if (window.innerWidth < 768){
    document.body.classList.add("mobile-view");
  }
  syncLabel();

  btn.addEventListener("click", ()=>{
    document.body.classList.toggle("mobile-view");
    syncLabel();
  });
}

/* ============================================================
   CSV Loader
============================================================ */

async function loadCSV(url){
  const res = await fetch(url);
  if (!res.ok){
    console.error("Errore nel caricamento CSV:", url, res.status);
    return [];
  }
  const text = await res.text();
  const rows = text.split(/\r?\n/).map(r=>r.trim()).filter(r=>r.length>0);
  if (!rows.length) return [];

  const headers = rows[0].split(",").map(h=>h.trim());

  return rows.slice(1).map(row=>{
    const cols = row.split(",");
    const obj = {};
    headers.forEach((h,i)=>{
      obj[h] = (cols[i] && cols[i].trim()) || "-";
    });
    return obj;
  });
}

/* ============================================================
   COSTRUZIONE CATALOGO + MODALI
============================================================ */

async function buildCatalogue(){
  const lang = currentLang || getInitialLang();
  const items = await loadCSV("catalogue/vasi.csv");
  if (!items.length) return;

  // Ordinamento: prima non venduti, poi venduti
  items.sort((a,b)=>{
    const av = (a.venduto || "").trim().toLowerCase();
    const bv = (b.venduto || "").trim().toLowerCase();
    const aSold = (av === "si" || av === "sì" || av === "yes");
    const bSold = (bv === "si" || bv === "sì" || bv === "yes");
    if (aSold === bSold) return 0;
    return aSold ? 1 : -1;
  });

  const grid = document.getElementById("catalogue-grid");
  if (!grid){
    console.warn("catalogue-grid non trovato");
    return;
  }

  let modalRoot = document.getElementById("modal-container");
  if (!modalRoot){
    modalRoot = document.createElement("div");
    modalRoot.id = "modal-container";
    document.body.appendChild(modalRoot);
  }

  grid.innerHTML = "";
  modalRoot.innerHTML = "";

  items.forEach(vase => {
    const langSafe = lang in messages ? lang : "ru";

    const name  = (vase[`name_${langSafe}`]  && vase[`name_${langSafe}`]  !== "-")
      ? vase[`name_${langSafe}`]
      : vase.name_ru || "";

    const short = (vase[`short_${langSafe}`] && vase[`short_${langSafe}`] !== "-")
      ? vase[`short_${langSafe}`]
      : vase.short_ru || "";

    const long  = (vase[`long_${langSafe}`]  && vase[`long_${langSafe}`]  !== "-")
      ? vase[`long_${langSafe}`]
      : vase.long_ru || "";

    const vendutoVal = (vase.venduto || "").trim().toLowerCase();
    const sold = (vendutoVal === "si" || vendutoVal === "sì" || vendutoVal === "yes");

    // immagine principale per la card: sempre img1, anche se venduto
    const img1Name = (vase.img1 || "").trim();
    const img1 = img1Name && img1Name !== "-"
      ? `images/catalogue/${img1Name}`
      : "images/placeholder.jpg";

    const priceOldStr = (vase.price_old && vase.price_old !== "-") ? vase.price_old : null;
    const priceNewStr = (vase.price_new && vase.price_new !== "-") ? vase.price_new : null;

    // calcolo sconto %
    let discount = null;
    if (!sold && priceOldStr && priceNewStr){
      const oldNum = parseFloat(String(priceOldStr).replace(",", "."));
      const newNum = parseFloat(String(priceNewStr).replace(",", "."));
      if (!isNaN(oldNum) && !isNaN(newNum) && oldNum > newNum){
        discount = Math.round((1 - newNum/oldNum)*100);
        if (discount <= 0) discount = null;
      }
    }

    /* ---------- CARD CATALOGO ---------- */

    let priceBlock = "";
    if (sold){
      priceBlock = `
        <div class="card-price">
          <span class="sold-badge">${messages[langSafe].status.sold}</span>
        </div>
      `;
    } else if (priceNewStr){
      priceBlock = `
        <div class="card-price">
          ${priceOldStr ? `<span class="old-price">${priceOldStr}€</span>` : ""}
          <span class="new-price">${priceNewStr}€</span>
          ${discount ? `<span class="discount-badge">-${discount}%</span>` : ""}
        </div>
      `;
    }

    const card = document.createElement("article");
    card.className = "card";

    card.innerHTML = `
      <div class="media media-single" data-modal-target="modal-${vase.id}">
        <img src="${img1}" alt="${name}">
        ${sold ? `<div class="sold-badge">${messages[langSafe].status.sold}</div>` : ""}
      </div>
      <div class="body">
        <h4>${name}</h4>
        <p>${short}</p>
        ${priceBlock}
        <button class="buy" data-modal-target="modal-${vase.id}">
          ${messages[langSafe].catalogue.viewPhotos}
        </button>
      </div>
    `;

    grid.appendChild(card);

    /* ---------- IMMAGINI PER MODALE ---------- */

    const imgs = [
      vase.img1, vase.img2, vase.img3,
      vase.img4, vase.img5, vase.img6
    ]
      .map(x => (x || "").trim())
      .filter(x => x && x !== "-");

    const galleryHTML = imgs.map((img,i)=>`
      <img src="images/catalogue/${img}" data-slide="${i}" class="${i === 0 ? "active" : ""}">
    `).join("");

    /* ---------- BLOCCO PREZZO IN MODALE ---------- */

    let modalPriceBlock = "";
    if (sold){
      modalPriceBlock = `
        <div class="vase-status-sold">
          ${messages[langSafe].status.sold}
        </div>
      `;
    } else if (priceNewStr){
      modalPriceBlock = `
        <div class="vase-price-row">
          ${priceOldStr ? `<span class="vase-old-price">${priceOldStr}€</span>` : ""}
          <span class="vase-price">${priceNewStr}€</span>
          ${discount ? `<span class="vase-discount">-${discount}%</span>` : ""}
        </div>
      `;
    }

    /* ---------- MODALE ---------- */

    const modal = document.createElement("div");
    modal.className = "modal";
    modal.id = `modal-${vase.id}`;

    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-header">
          <h4>${name}</h4>
          ${sold ? `<span class="sold-badge sold-badge-modal">${messages[langSafe].status.sold}</span>` : ""}
          <button data-modal-close>×</button>
        </div>

        <div class="modal-body">
          <div class="modal-body-inner">

            <div class="vase-detail-panel">
              <h2 class="vase-title">${name}</h2>
              <p>${short}</p>

              ${modalPriceBlock}

              <div class="accordion">

                <button class="accordion-header">
                  ${messages[langSafe].detail.description}
                  <span>›</span>
                </button>
                <div class="accordion-panel">
                  ${long}
                </div>

                <button class="accordion-header">
                  ${messages[langSafe].detail.characteristics}
                  <span>›</span>
                </button>
                <div class="accordion-panel">
                  <dl>
                    <dt>${messages[langSafe].catalogue.spec.height}</dt><dd>${vase.height || "-"}</dd>
                    <dt>${messages[langSafe].catalogue.spec.diameter}</dt><dd>${vase.diameter || "-"}</dd>
                    <dt>${messages[langSafe].catalogue.spec.material}</dt><dd>${vase.material || "-"}</dd>
                    <dt>${messages[langSafe].catalogue.spec.technique}</dt><dd>${vase.technique || "-"}</dd>
                    <dt>${messages[langSafe].catalogue.spec.finish}</dt><dd>${vase.finish || "-"}</dd>
                  </dl>
                </div>

                <button class="accordion-header">
                  ${messages[langSafe].detail.delivery}
                  <span>›</span>
                </button>
                <div class="accordion-panel">
                  ${messages[langSafe].detail.deliveryText}
                </div>

              </div>
            </div>

            <div class="modal-gallery">
              <div class="modal-gallery-main">
                ${galleryHTML}
              </div>
              <div class="modal-gallery-controls">
                <button data-gallery-prev>←</button>
                <span data-gallery-counter></span>
                <button data-gallery-next>→</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;

    modalRoot.appendChild(modal);
  });

  initModals();
  initAccordion();
}

/* ============================================================
   MODALI + GALLERY
============================================================ */

function initModals(){
  // apertura modale (immagine + bottone "Vedi foto")
  document.querySelectorAll("[data-modal-target]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const id = el.dataset.modalTarget;
      const modal = document.getElementById(id);
      if (modal) modal.classList.add("open");
    });
  });

  // chiusura con bottone ×
  document.querySelectorAll("[data-modal-close]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const modal = btn.closest(".modal");
      if (modal) modal.classList.remove("open");
    });
  });

  // per ogni modale, gestiamo click sullo sfondo + gallery
  document.querySelectorAll(".modal").forEach(modal=>{
    // chiusura cliccando sullo sfondo
    modal.addEventListener("click", e=>{
      if (e.target === modal) modal.classList.remove("open");
    });

    const main = modal.querySelector(".modal-gallery-main");
    if (!main) return;

    const slides = [...main.querySelectorAll("img[data-slide]")];
    if (!slides.length) return;

    let index = 0;
    const counter = modal.querySelector("[data-gallery-counter]");

    const update = ()=>{
      slides.forEach((img,i)=>{
        img.classList.toggle("active", i === index);
      });
      if (counter){
        counter.textContent = `${index+1} / ${slides.length}`;
      }
    };

    update(); // inizializza a "1 / N"

    const prevBtn = modal.querySelector("[data-gallery-prev]");
    const nextBtn = modal.querySelector("[data-gallery-next]");

    if (prevBtn){
      prevBtn.addEventListener("click", e=>{
        e.stopPropagation();
        index = (index - 1 + slides.length) % slides.length;
        update();
      });
    }

    if (nextBtn){
      nextBtn.addEventListener("click", e=>{
        e.stopPropagation();
        index = (index + 1) % slides.length;
        update();
      });
    }
  });
}

/* ============================================================
   ACCORDION
============================================================ */

function initAccordion(){
  document.querySelectorAll(".accordion").forEach(acc=>{
    acc.querySelectorAll(".accordion-header").forEach(h=>{
      h.addEventListener("click", ()=>{
        const panel = h.nextElementSibling;
        const open = panel.classList.contains("active");
        acc.querySelectorAll(".accordion-panel").forEach(p=>p.classList.remove("active"));
        if (!open) panel.classList.add("active");
      });
    });
  });
}

/* ============================================================
   INIT SITO
============================================================ */

window.appInit = function(){
  const lang = getInitialLang();
  setLang(lang);          // setLang applica traduzioni e costruisce il catalogo
  initViewToggle();
  initMobileNav();
};

/* ============================================================
   CAMBIO LINGUA DAL SELECT
============================================================ */

document.addEventListener("change", e=>{
  if (e.target && e.target.id === "language-selector"){
    setLang(e.target.value);
  }
});

