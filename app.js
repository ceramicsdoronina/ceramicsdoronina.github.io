/* ============================================================
   LINGUE ‚Äì dizionario di traduzione
============================================================ */

const messages = {
  ru: {
    nav:{home:"–ì–ª–∞–≤–Ω–∞—è",about:"–û –±—Ä–µ–Ω–¥–µ",catalogue:"–ö–∞—Ç–∞–ª–æ–≥",workshops:"–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã",contact:"–ö–æ–Ω—Ç–∞–∫—Ç—ã"},
    hero:{tagline:"–¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä—å–µ—Ä–Ω–∞—è –∫–µ—Ä–∞–º–∏–∫–∞ —Å –±–∏—Å–µ—Ä–Ω–æ–π –≤—ã—à–∏–≤–∫–æ–π, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç –≤–∞—à –¥–æ–º –≤ –º–µ—Å—Ç–æ —Å–∏–ª—ã –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è"},
    about:{
      title:"–û –±—Ä–µ–Ω–¥–µ",
      intro1:"–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞, –∏ —è —Å–æ–∑–¥–∞—é –∏–Ω—Ç–µ—Ä—å–µ—Ä–Ω—É—é –∫–µ—Ä–∞–º–∏–∫—É –∫–∞–∫ –æ–±—ä–µ–∫—Ç –∏—Å–∫—É—Å—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç, –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–∞—Å—Ç—å—é –≤–∞—à–µ–≥–æ –ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ —Å–∏–ª—ã.",
      intro2:"–Ø –≤–µ—Ä—é, —á—Ç–æ –ø—Ä–µ–¥–º–µ—Ç—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã –∂–∏–≤—ë–º, –≤–ª–∏—è—é—Ç –Ω–∞ –Ω–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.",
      btnCatalogue:"–ö–∞—Ç–∞–ª–æ–≥",
      btnWorkshops:"–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã",
      btnGiftCards:"–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã",
      text1:"–ú–æ–∏ –≤–∞–∑—ã ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ä–º—ã, –∞ –ø—Ä–µ–¥–º–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è—é—Ç –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –¥–æ–º–∞.",
      text2:"–í –∫–∞–∂–¥–æ–π —Ä–∞–±–æ—Ç–µ ‚Äî –≤—ã—Å–æ–∫–æ—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è –≥–ª–∏–Ω–∞, —Ç–∞–∫—Ç–∏–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã, –±–∏—Å–µ—Ä–Ω–∞—è –≤—ã—à–∏–≤–∫–∞ –∏ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã —Å –æ—â—É—â–µ–Ω–∏–µ–º —Ä–æ—Å–∫–æ—à–∏."
    },
    catalogue:{
      title:"–ö–∞—Ç–∞–ª–æ–≥",
      lead:"–ö–∞–∂–¥–æ–µ –∏–∑–¥–µ–ª–∏–µ ‚Äî —ç—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω–∞—è —ç–º–æ—Ü–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞",
      viewPhotos:"–°–º–æ—Ç—Ä–µ—Ç—å —Ñ–æ—Ç–æ",
      spec:{height:"–í—ã—Å–æ—Ç–∞",diameter:"–î–∏–∞–º–µ—Ç—Ä",material:"–ú–∞—Ç–µ—Ä–∏–∞–ª",technique:"–¢–µ—Ö–Ω–∏–∫–∞",finish:"–ü–æ–∫—Ä—ã—Ç–∏–µ"}
    },
    detail:{
      description:"–û–ø–∏—Å–∞–Ω–∏–µ",
      characteristics:"–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏",
      delivery:"–î–æ—Å—Ç–∞–≤–∫–∞",
      deliveryText:"–ú—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–¥–µ–ª–∏—è –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É."
    },
    status:{sold:"–ü—Ä–æ–¥–∞–Ω–æ"},
    contact:{title:"–ö–æ–Ω—Ç–∞–∫—Ç—ã",address:"–ê–¥—Ä–µ—Å –º–∞—Å—Ç–µ—Ä—Å–∫–æ–π:"},
    footer:{made:"–°–∞–π—Ç —Å–æ–∑–¥–∞–Ω –Ω–∞ GitHub Pages"}
  },

  it: {
    nav:{home:"Home",about:"Il brand",catalogue:"Catalogo",workshops:"Masterclass",contact:"Contatti"},
    hero:{tagline:"Ceramica tattile da interno con ricami di perle che trasforma la tua casa in un luogo di forza e ispirazione."},
    about:{
      title:"Il brand",
      intro1:"Mi chiamo Anna e creo ceramiche d‚Äôinterni come oggetti d‚Äôarte.",
      intro2:"Credo che gli oggetti con cui viviamo influenzino il nostro stato interiore.",
      btnCatalogue:"Catalogo",
      btnWorkshops:"Masterclass",
      btnGiftCards:"Gift Card",
      text1:"I miei vasi non sono solo forme, ma oggetti che trasformano l‚Äôatmosfera.",
      text2:"In ogni pezzo ci sono argille ad alta temperatura, texture tattili e ricami di perle."
    },
    catalogue:{
      title:"Catalogo",
      lead:"Ogni pezzo √® un‚Äôemozione unica per il tuo spazio.",
      viewPhotos:"Vedi foto",
      spec:{height:"Altezza",diameter:"Diametro",material:"Materiale",technique:"Tecnica",finish:"Finitura"}
    },
    detail:{
      description:"Descrizione",
      characteristics:"Caratteristiche",
      delivery:"Spedizione",
      deliveryText:"Spediamo in tutto il mondo dalla Liguria."
    },
    status:{sold:"Venduto"},
    contact:{title:"Contatti",address:"Studio:"},
    footer:{made:"Realizzato con GitHub Pages"}
  },

  en: {
    nav:{home:"Home",about:"About",catalogue:"Catalogue",workshops:"Workshops",contact:"Contact"},
    hero:{tagline:"Tactile interior ceramics with bead embroidery."},
    about:{
      title:"About the brand",
      intro1:"My name is Anna and I create interior ceramics as art objects.",
      intro2:"Objects we live with shape our inner state.",
      btnCatalogue:"Catalogue",
      btnWorkshops:"Workshops",
      btnGiftCards:"Gift Cards",
      text1:"My vases transform the atmosphere of your home.",
      text2:"High-fire clays, textures, bead embroidery, quiet luxury."
    },
    catalogue:{
      title:"Catalogue",
      lead:"Each piece is a unique emotion for your space.",
      viewPhotos:"View photos",
      spec:{height:"Height",diameter:"Diameter",material:"Material",technique:"Technique",finish:"Finish"}
    },
    detail:{
      description:"Description",
      characteristics:"Characteristics",
      delivery:"Shipping",
      deliveryText:"We ship worldwide from Liguria."
    },
    status:{sold:"Sold out"},
    contact:{title:"Contact",address:"Studio address:"},
    footer:{made:"Made with GitHub Pages"}
  }
};

/* ============================================================
   TRADUZIONI
============================================================ */
function applyTranslations(lang){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const keys = el.dataset.i18n.split(".");
    let value = messages[lang];
    for (const k of keys){
      if (value && value[k] != null) value = value[k];
    }
    if (typeof value === "string") el.textContent = value;
  });
}

function getInitialLang(){
  const saved = localStorage.getItem("lang");
  if (saved && messages[saved]) return saved;
  const browser = (navigator.language||"ru").slice(0,2);
  return messages[browser] ? browser : "ru";
}

function setLang(lang){
  localStorage.setItem("lang", lang);
  applyTranslations(lang);
  buildCatalogue();
}

/* ============================================================
   MENU MOBILE
============================================================ */
function initMobileNav(){
  const btn = document.getElementById("nav-toggle");
  if (!btn) return;
  btn.addEventListener("click", ()=>{
    document.body.classList.toggle("nav-open");
  });
  document.querySelectorAll("nav a").forEach(a=>{
    a.addEventListener("click", ()=>{
      document.body.classList.remove("nav-open");
    });
  });
}

/* ============================================================
   TOGGLE DESKTOP/MOBILE-VIEW
============================================================ */
function initViewToggle(){
  const btn = document.getElementById("view-toggle-btn");
  if (!btn) return;

  if (window.innerWidth < 768){
    document.body.classList.add("mobile-view");
    btn.textContent = "Desktop";
  } else {
    btn.textContent = "Mobile";
  }

  btn.addEventListener("click", ()=>{
    document.body.classList.toggle("mobile-view");
    btn.textContent = document.body.classList.contains("mobile-view")
      ? "Desktop"
      : "Mobile";
  });
}

/* ============================================================
   CSV Loader
============================================================ */
async function loadCSV(url){
  const res = await fetch(url);
  const text = await res.text();
  const rows = text.split("\n").map(r=>r.trim()).filter(r=>r.length>0);
  const headers = rows[0].split(",");
  return rows.slice(1).map(row=>{
    const cols = row.split(",");
    const obj = {};
    headers.forEach((h,i)=> obj[h.trim()] = cols[i] ? cols[i].trim() : "-");
    return obj;
  });
}

/* ============================================================
   COSTRUZIONE DINAMICA CATALOGO + MODALI
============================================================ */
async function buildCatalogue(){
  const lang = getInitialLang();
  const items = await loadCSV("catalogue/vasi.csv");

  // üî• Ordinamento: disponibili ‚Üí venduti
  items.sort((a,b)=> (a.venduto==="si") - (b.venduto==="si"));

  const grid = document.getElementById("catalogue-grid");
  const modalRoot = document.getElementById("modal-container");

  grid.innerHTML = "";
  modalRoot.innerHTML = "";

  items.forEach(vase => {

    const name = vase[`name_${lang}`] !== "-" ? vase[`name_${lang}`] : vase.name_ru;
    const short = vase[`short_${lang}`] !== "-" ? vase[`short_${lang}`] : vase.short_ru;
    const long = vase[`long_${lang}`] !== "-" ? vase[`long_${lang}`] : vase.long_ru;

    const sold = vase.venduto === "si";

    const img1 = vase.img1 !== "-" ? `images/catalogue/${vase.img1}` : "images/placeholder.jpg";

    const priceOld = vase.price_old !== "-" ? vase.price_old : null;
    const priceNew = vase.price_new !== "-" ? vase.price_new : null;

    /* ---------- CARD CATALOGO ---------- */
    const card = document.createElement("article");
    card.className = "card";

    card.innerHTML = `
      <div class="media media-single" data-modal-target="modal-${vase.id}">
        <img src="${img1}" alt="${name}">
        ${sold ? `<div class="sold-badge">${messages[lang].status.sold}</div>` : ""}
      </div>
      <div class="body">
        <h4>${name}</h4>
        <p>${short}</p>

        ${priceNew ? `
          <div class="card-price">
            ${priceOld ? `<span class="old-price">${priceOld}‚Ç¨</span>` : ""}
            <span class="new-price">${priceNew}‚Ç¨</span>
          </div>
        ` : ""}

        <button class="buy" data-modal-target="modal-${vase.id}">
          ${messages[lang].catalogue.viewPhotos}
        </button>
      </div>
    `;

    grid.appendChild(card);

    /* ---------- IMMAGINI MODALE ---------- */
    const imgs = [
      vase.img1,vase.img2,vase.img3,vase.img4,vase.img5,vase.img6
    ].filter(x=>x && x !== "-");

    const gallery = imgs.map((img,i)=>`
      <img src="images/catalogue/${img}" data-slide="${i}" class="${i===0?"active":""}">
    `).join("");

    /* ---------- MODALE ---------- */
    const modal = document.createElement("div");
    modal.className = "modal";
    modal.id = `modal-${vase.id}`;

    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-header">
          <h4>${name}</h4>
          ${sold ? `<span class="sold-badge sold-badge-modal">${messages[lang].status.sold}</span>` : ""}
          <button data-modal-close>√ó</button>
        </div>

        <div class="modal-body">
          <div class="modal-body-inner">

            <div class="vase-detail-panel">
              <h2 class="vase-title">${name}</h2>
              <p>${short}</p>

              ${priceNew ? `
                <div class="vase-price-row">
                  ${priceOld ? `<span class="vase-old-price">${priceOld}‚Ç¨</span>` : ""}
                  <span class="vase-price">${priceNew}‚Ç¨</span>
                </div>
              ` : ""}

              <div class="accordion">

                <button class="accordion-header">
                  ${messages[lang].detail.description}
                  <span>‚Ä∫</span>
                </button>
                <div class="accordion-panel">${long}</div>

                <button class="accordion-header">
                  ${messages[lang].detail.characteristics}
                  <span>‚Ä∫</span>
                </button>
                <div class="accordion-panel">
                  <dl>
                    <dt>${messages[lang].catalogue.spec.height}</dt><dd>${vase.height}</dd>
                    <dt>${messages[lang].catalogue.spec.diameter}</dt><dd>${vase.diameter}</dd>
                    <dt>${messages[lang].catalogue.spec.material}</dt><dd>${vase.material}</dd>
                    <dt>${messages[lang].catalogue.spec.technique}</dt><dd>${vase.technique}</dd>
                    <dt>${messages[lang].catalogue.spec.finish}</dt><dd>${vase.finish}</dd>
                  </dl>
                </div>

                <button class="accordion-header">
                  ${messages[lang].detail.delivery}
                  <span>‚Ä∫</span>
                </button>
                <div class="accordion-panel">
                  ${messages[lang].detail.deliveryText}
                </div>

              </div>
            </div>

            <div class="modal-gallery">
              <div class="modal-gallery-main">
                ${gallery}
              </div>
              <div class="modal-gallery-controls">
                <button data-gallery-prev>‚Üê</button>
                <span data-gallery-counter>1 / ${imgs.length}</span>
                <button data-gallery-next>‚Üí</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;

    modalRoot.appendChild(modal);
  });

  initModals();
  initAccordion();
}

/* ============================================================
   MODALI + GALLERY
============================================================ */
function initModals(){
  document.querySelectorAll("[data-modal-target]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const id = el.dataset.modalTarget;
      document.getElementById(id)?.classList.add("open");
    });
  });

  document.querySelectorAll("[data-modal-close]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      btn.closest(".modal").classList.remove("open");
    });
  });

  document.querySelectorAll(".modal").forEach(modal=>{
    modal.addEventListener("click", e=>{
      if (e.target === modal) modal.classList.remove("open");
    });

    const main = modal.querySelector(".modal-gallery-main");
    if (!main) return;

    const slides = [...main.querySelectorAll("img[data-slide]")];
    let index = 0;
    const counter = modal.querySelector("[data-gallery-counter]");

    const update = ()=>{
      slides.forEach((img,i)=> img.classList.toggle("active", i===index));
      counter.textContent = `${index+1} / ${slides.length}`;
    };

    update();

    modal.querySelector("[data-gallery-prev]")?.addEventListener("click", ()=>{
      index = (index - 1 + slides.length) % slides.length;
      update();
    });

    modal.querySelector("[data-gallery-next]")?.addEventListener("click", ()=>{
      index = (index + 1) % slides.length;
      update();
    });
  });
}

/* ============================================================
   ACCORDION
============================================================ */
function initAccordion(){
  document.querySelectorAll(".accordion").forEach(acc=>{
    acc.querySelectorAll(".accordion-header").forEach(h=>{
      h.addEventListener("click", ()=>{
        const panel = h.nextElementSibling;
        const open = panel.classList.contains("active");
        acc.querySelectorAll(".accordion-panel").forEach(p=>p.classList.remove("active"));
        if (!open) panel.classList.add("active");
      });
    });
  });
}

/* ============================================================
   INIT SITO
============================================================ */
window.appInit = function(){
  const lang = getInitialLang();
  applyTranslations(lang);
  initViewToggle();
  initMobileNav();
  buildCatalogue();
}

/* ============================================================
   CAMBIO LINGUA
============================================================ */
document.addEventListener("change", e=>{
  if (e.target.id === "language-selector"){
    setLang(e.target.value);
  }
});

