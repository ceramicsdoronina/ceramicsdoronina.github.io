/* ============================================================
   LINGUE – dizionario di traduzione
============================================================ */

const messages = {
  ru: {
    nav: {
      home: "Главная",
      about: "О бренде",
      catalogue: "Каталог",
      workshops: "Мастер-классы",
      giftcards: "Подарочные сертификаты",
      contact: "Контакты"
    },
    hero: {
      tagline: "Тактильная интерьерная керамика с бисерной вышивкой, которая превратит ваш дом в место силы и вдохновения."
    },
    about: {
      title: "О бренде",
      intro1: "Меня зовут Анна, и я создаю интерьерную керамику как объект искусства, который поддерживает, вдохновляет и становится частью вашего личного пространства силы.",
      intro2: "Я верю, что предметы, с которыми мы живём, влияют на наше состояние.",
      btnCatalogue: "Каталог",
      btnWorkshops: "Мастер-классы",
      btnGiftCards: "Подарочные сертификаты",
      text1: "Мои вазы — это не просто формы, а предметы, которые меняют атмосферу дома.",
      text2: "В каждой работе — высокотемпературная глина, тактильные текстуры, бисерная вышивка и сочетание несовершенных форм с ощущением роскоши."
    },
    catalogue: {
      title: "Каталог",
      lead: "Каждое изделие — это уникальная эмоция для вашего пространства",
      viewPhotos: "Смотреть фото",
      addToCart: "Добавить в корзину",
      spec: {
        height: "Высота",
        diameter: "Диаметр",
        material: "Материал",
        technique: "Техника",
        finish: "Покрытие"
      }
    },
    detail: {
      description: "Описание",
      characteristics: "Характеристики",
      delivery: "Доставка",
      deliveryText: "Отправляем по всему миру из Лигурии, надёжно упаковывая каждое изделие."
    },
    workshops: {
      title: "Мастер-классы",
      lead: "Керамические мастер-классы в маленьких группах в атмосфере внимания и спокойствия.",
      list1: "Индивидуальные и групповые занятия в студии в Генуе.",
      list2: "Формы, тактильные поверхности, работа с глазурями и декором.",
      list3: "Формат для компаний и частных мероприятий по запросу.",
      note: "За актуальным расписанием и для организации частного мастер-класса напишите мне."
    },
    giftcards: {
      title: "Подарочные сертификаты",
      lead: "Подарите эмоцию прикосновения к глине или выбор керамического объекта для дома.",
      list1: "Сертификат на участие в мастер-классе.",
      list2: "Сертификат на готовое изделие или персональный заказ.",
      list3: "Электронный формат или оформленная карточка, готовая к вручению.",
      note: "Напишите мне, чтобы подобрать формат сертификата под ваш запрос."
    },
    status: {
      sold: "Продано"
    },
    contact: {
      title: "Контакты",
      address: "Мастерская:"
    },
    footer: {
      made: "Сайт на GitHub Pages"
    }
  },

  it: {
    nav: {
      home: "Home",
      about: "Il brand",
      catalogue: "Catalogo",
      workshops: "Masterclass",
      giftcards: "Gift Card",
      contact: "Contatti"
    },
    hero: {
      tagline: "Ceramica tattile da interno con ricami di perle che trasforma la tua casa in un luogo di forza e ispirazione."
    },
    about: {
      title: "Il brand",
      intro1: "Mi chiamo Anna e creo ceramiche d’interni come oggetti d’arte che sostengono, ispirano e diventano parte del tuo spazio personale di forza.",
      intro2: "Credo che gli oggetti con cui viviamo influenzino il nostro stato interiore.",
      btnCatalogue: "Catalogo",
      btnWorkshops: "Masterclass",
      btnGiftCards: "Gift Card",
      text1: "I miei vasi non sono solo forme, ma oggetti che trasformano l’atmosfera della casa.",
      text2: "In ogni pezzo ci sono argille ad alta temperatura, superfici tattili, ricami di perle e l’unione di forme imperfette con una sensazione di lusso."
    },
    catalogue: {
      title: "Catalogo",
      lead: "Ogni pezzo è un’emozione unica per il tuo spazio.",
      viewPhotos: "Vedi foto",
      addToCart: "Aggiungi al carrello",
      spec: {
        height: "Altezza",
        diameter: "Diametro",
        material: "Materiale",
        technique: "Tecnica",
        finish: "Finitura"
      }
    },
    detail: {
      description: "Descrizione",
      characteristics: "Caratteristiche",
      delivery: "Spedizione",
      deliveryText: "Spediamo in tutto il mondo dalla Liguria, con imballaggio protettivo."
    },
    workshops: {
      title: "Masterclass",
      lead: "Workshop di ceramica in piccoli gruppi, in un’atmosfera di cura e tranquillità.",
      list1: "Percorsi individuali e di gruppo nel mio studio a Genova.",
      list2: "Forme, superfici tattili, lavoro con smalti e decorazioni.",
      list3: "Format per aziende e eventi privati su richiesta.",
      note: "Per il calendario aggiornato o per organizzare una masterclass privata, scrivimi."
    },
    giftcards: {
      title: "Gift Card",
      lead: "Regala l’emozione di lavorare con l’argilla o di scegliere un oggetto in ceramica per la casa.",
      list1: "Buono per partecipare a una masterclass.",
      list2: "Buono per un pezzo finito o per una commissione su misura.",
      list3: "Formato digitale o card stampata pronta da regalare.",
      note: "Scrivimi per trovare insieme il formato di gift card più adatto."
    },
    status: {
      sold: "Venduto"
    },
    contact: {
      title: "Contatti",
      address: "Studio:"
    },
    footer: {
      made: "Realizzato con GitHub Pages"
    }
  },

  en: {
    nav: {
      home: "Home",
      about: "About",
      catalogue: "Catalogue",
      workshops: "Masterclass",
      giftcards: "Gift Cards",
      contact: "Contact"
    },
    hero: {
      tagline: "Tactile interior ceramics with pearl embroidery that turns your home into a place of strength and inspiration."
    },
    about: {
      title: "About the brand",
      intro1: "My name is Anna, and I create interior ceramics as art objects that support, inspire, and become part of your personal space of strength.",
      intro2: "I believe that the objects we live with influence our inner state.",
      btnCatalogue: "Catalogue",
      btnWorkshops: "Masterclass",
      btnGiftCards: "Gift Cards",
      text1: "My vases are not just shapes, but objects that transform the atmosphere of a home.",
      text2: "Each piece combines high-temperature clays, tactile textures, bead embroidery, and the meeting of imperfect forms with a sense of luxury."
    },
    catalogue: {
      title: "Catalogue",
      lead: "Each piece is a unique emotion for your space.",
      viewPhotos: "View photos",
      addToCart: "Add to cart",
      spec: {
        height: "Height",
        diameter: "Diameter",
        material: "Material",
        technique: "Technique",
        finish: "Finish"
      }
    },
    detail: {
      description: "Description",
      characteristics: "Characteristics",
      delivery: "Shipping",
      deliveryText: "We ship worldwide from Liguria, Italy."
    },
    workshops: {
      title: "Masterclass",
      lead: "Ceramic workshops in small groups, in a calm and attentive atmosphere.",
      list1: "Individual and group sessions in my studio in Genoa.",
      list2: "Forms, tactile surfaces, working with glazes and decoration.",
      list3: "Formats for companies and private events upon request.",
      note: "For the updated calendar or to organise a private masterclass, write to me."
    },
    giftcards: {
      title: "Gift Cards",
      lead: "Offer the emotion of working with clay or choosing a ceramic object for the home.",
      list1: "Voucher for attending a masterclass.",
      list2: "Voucher for a finished piece or a bespoke commission.",
      list3: "Digital format or printed card ready to gift.",
      note: "Write to me to find the most suitable gift card format for you."
    },
    status: {
      sold: "Sold out"
    },
    contact: {
      title: "Contact",
      address: "Studio address:"
    },
    footer: {
      made: "Made with GitHub Pages"
    }
  }
};

/* ============================================================
   STATO LINGUA + VISTA (desktop/mobile)
============================================================ */

let currentLang = "it";
let viewMode = "desktop"; // "desktop" | "mobile"

/* ------------------------------------------------------------
   rileva lingua preferita
------------------------------------------------------------ */
function detectInitialLang(){
  const saved = localStorage.getItem("cd_lang");
  if (saved && messages[saved]) return saved;

  const browser = (navigator.language || navigator.userLanguage || "it").slice(0,2);
  if (messages[browser]) return browser;

  return "it";
}

/* ------------------------------------------------------------
   applica lingua a tutti i data-i18n
------------------------------------------------------------ */
function applyTranslations(lang){
  const dict = messages[lang];
  if (!dict) return;

  document.documentElement.lang = lang;

  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const path = el.getAttribute("data-i18n").split(".");
    let cur = dict;
    for (const p of path){
      cur = cur && cur[p];
    }
    if (typeof cur === "string"){
      el.textContent = cur;
    }
  });

  // aggiorna il selettore lingua (se presente)
  const langSelect = document.getElementById("language-selector");
  if (langSelect){
    langSelect.value = lang;
  }
}

/* ------------------------------------------------------------
   cambia lingua
------------------------------------------------------------ */
function setLanguage(lang){
  if (!messages[lang]) return;
  currentLang = lang;
  localStorage.setItem("cd_lang", lang);
  applyTranslations(lang);
  // ricarica il catalogo se esiste
  if (window.__catalogueData){
    renderCatalogue(window.__catalogueData, currentLang);
  }
}

/* ============================================================
   IMPORT CSV VASI
============================================================ */

async function loadCsv(){
  const res = await fetch("catalogue/vasi.csv", { cache: "no-store" });
  if (!res.ok){
    console.error("Impossibile caricare vasi.csv");
    return [];
  }

  const text = await res.text();

  // righe non vuote
  const rows = text.trim().split(/\r?\n/).filter(r => r.trim().length > 0);
  if (rows.length < 2) return [];

  // rilevo automaticamente il separatore: virgola o punto-e-virgola
  const firstLine = rows[0];
  const delimiter = (firstLine.includes(";") && !firstLine.includes(",")) ? ";" : ",";

  const header = firstLine.split(delimiter).map(h => h.trim());

  return rows.slice(1).map(line => {
    const cols = line.split(delimiter).map(c => c.trim());
    const obj = {};
    header.forEach((h, i) => {
      obj[h] = cols[i] ?? "";
    });
    return obj;
  });
}

/* ============================================================
   RENDER CATALOGO
============================================================ */
function renderCatalogue(items, lang){
  const grid = document.getElementById("catalogue-grid");
  const modalRoot = document.getElementById("modal-container");

  if (!grid){
    console.warn("catalogue-grid non trovato nel DOM");
    return;
  }

  // ordina: prima non venduti, poi venduti
  items.sort((a,b)=>{
    const aSold = (a.venduto || "").trim().toLowerCase() === "si";
    const bSold = (b.venduto || "").trim().toLowerCase() === "si";
    if (aSold === bSold) return 0;
    return aSold ? 1 : -1;
  });

  grid.innerHTML = "";
  if (modalRoot) modalRoot.innerHTML = "";

  items.forEach(vase=>{
    const name  = vase[`name_${lang}`]  && vase[`name_${lang}`]  !== "-" ? vase[`name_${lang}`]  : vase.name_ru;
    const short = vase[`short_${lang}`] && vase[`short_${lang}`] !== "-" ? vase[`short_${lang}`] : vase.short_ru;
    const long  = vase[`long_${lang}`]  && vase[`long_${lang}`]  !== "-" ? vase[`long_${lang}`]  : vase.long_ru;

    const sold = (vase.venduto || "").trim().toLowerCase() === "si";

    const img1 = vase.img1 && vase.img1 !== "-" ? `images/catalogue/${vase.img1}` : "images/placeholder.jpg";

    const priceOldStr = vase.price_old && vase.price_old !== "-" ? vase.price_old : null;
    const priceNewStr = vase.price_new && vase.price_new !== "-" ? vase.price_new : null;

    // Calcolo sconto in % se possibile
    let discount = null;
    if (!sold && priceOldStr && priceNewStr){
      const oldNum = parseFloat(String(priceOldStr).replace(",", "."));
      const newNum = parseFloat(String(priceNewStr).replace(",", "."));
      if (!isNaN(oldNum) && !isNaN(newNum) && oldNum > newNum){
        discount = Math.round((1 - newNum/oldNum)*100);
      }
    }

    let cardStatusBlock = "";
    if (sold){
      cardStatusBlock = `
        <p class="card-status card-status-sold">
          ${messages[lang].status.sold}
        </p>
      `;
    } else if (priceNewStr){
      // blocco prezzi nella card
      const discountBlock = discount !== null
        ? `<span class="price-discount">-${discount}%</span>`
        : "";
      if (priceOldStr){
        cardStatusBlock = `
          <div class="card-price">
            <span class="price-old">${priceOldStr}€</span>
            <span class="price-current">${priceNewStr}€</span>
            ${discountBlock}
          </div>
        `;
      } else {
        cardStatusBlock = `
          <div class="card-price">
            <span class="price-current">${priceNewStr}€</span>
            ${discountBlock}
          </div>
        `;
      }
    }

    const addCartHtml = !sold
      ? `<button class="add-cart" data-id="${vase.id}">
          ${messages[lang].catalogue.addToCart}
        </button>`
      : "";

    const card = document.createElement("article");
    card.className = "card";

    card.innerHTML = `
      <div class="media media-single" data-modal-target="modal-${vase.id}">
        <img src="${img1}" alt="${name}">
      </div>
      <div class="body">
        <h4>${name}</h4>
        <p>${short}</p>
        ${cardStatusBlock}
        <button class="buy" data-modal-target="modal-${vase.id}">
          ${messages[lang].catalogue.viewPhotos}
        </button>
        ${addCartHtml}
      </div>
    `;

    grid.appendChild(card);

    /* ---------- IMMAGINI MODALE ---------- */
    const imgs = [
      vase.img1,vase.img2,vase.img3,
      vase.img4,vase.img5,vase.img6
    ].filter(x=>x && x !== "-")
     .map(fn=>`images/catalogue/${fn}`);

    if (!modalRoot) return;

    const modal = document.createElement("div");
    modal.className = "modal";
    modal.id = `modal-${vase.id}`;

    let priceBlock = "";
    if (sold){
      priceBlock = `
        <div class="vase-price-row">
          <span class="vase-price">${messages[lang].status.sold}</span>
        </div>
      `;
    } else if (priceNewStr){
      const discountBlock = discount !== null
        ? `<span class="vase-discount">-${discount}%</span>`
        : "";
      if (priceOldStr){
        priceBlock = `
          <div class="vase-price-row">
            <span class="vase-old-price">${priceOldStr}€</span>
            <span class="vase-price">${priceNewStr}€</span>
            ${discountBlock}
          </div>
        `;
      } else {
        priceBlock = `
          <div class="vase-price-row">
            <span class="vase-price">${priceNewStr}€</span>
            ${discountBlock}
          </div>
        `;
      }
    }

    const spec = messages[lang].catalogue.spec;

    const galleryImgsHtml = imgs.map((src,idx)=>`
      <img src="${src}" alt="${name} ${idx+1}" data-index="${idx}" class="${idx===0?"active":""}">
    `).join("");

    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-header">
          <h2 class="vase-title">${name}</h2>
          <button type="button" data-modal-close>×</button>
        </div>
        <div class="modal-body">
          <div class="modal-body-inner">
            <div class="vase-detail-panel">
              <h3 class="vase-subtitle">${short}</h3>
              ${priceBlock}
              <div class="vase-actions">
                <button class="vase-btn-primary">${messages[lang].catalogue.viewPhotos}</button>
                <button class="vase-btn-outline">${messages[lang].catalogue.title}</button>
              </div>

              <button class="accordion-header" data-acc-target="desc-${vase.id}">
                <span>${messages[lang].detail.description}</span>
                <span>›</span>
              </button>
              <div class="accordion-panel" id="desc-${vase.id}">
                <p>${long}</p>
              </div>

              <button class="accordion-header" data-acc-target="spec-${vase.id}">
                <span>${messages[lang].detail.characteristics}</span>
                <span>›</span>
              </button>
              <div class="accordion-panel" id="spec-${vase.id}">
                <div class="vase-specs">
                  <dl>
                    ${vase.height && vase.height !== "-" ? `<dt>${spec.height}</dt><dd>${vase.height}</dd>` : ""}
                    ${vase.diameter && vase.diameter !== "-" ? `<dt>${spec.diameter}</dt><dd>${vase.diameter}</dd>` : ""}
                    ${vase.material && vase.material !== "-" ? `<dt>${spec.material}</dt><dd>${vase.material}</dd>` : ""}
                    ${vase.technique && vase.technique !== "-" ? `<dt>${spec.technique}</dt><dd>${vase.technique}</dd>` : ""}
                    ${vase.finish && vase.finish !== "-" ? `<dt>${spec.finish}</dt><dd>${vase.finish}</dd>` : ""}
                  </dl>
                </div>
              </div>

              <button class="accordion-header" data-acc-target="del-${vase.id}">
                <span>${messages[lang].detail.delivery}</span>
                <span>›</span>
              </button>
              <div class="accordion-panel" id="del-${vase.id}">
                <p>${messages[lang].detail.deliveryText}</p>
              </div>
            </div>

            <div class="modal-gallery">
              <div class="modal-gallery-main">
                ${galleryImgsHtml}
              </div>
              <div class="modal-gallery-counter" data-gallery-counter="${vase.id}">
                1 / ${imgs.length}
              </div>
              <div class="modal-gallery-controls" data-gallery-controls="${vase.id}">
                <button type="button" data-gallery-prev>←</button>
                <button type="button" data-gallery-next>→</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    modalRoot.appendChild(modal);
  });

  initModals();
  initAccordions();
  initGalleries();
}

/* ============================================================
   MODALI + GALLERY
============================================================ */
function initModals(){
  document.querySelectorAll("[data-modal-target]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const id = el.dataset.modalTarget;
      document.getElementById(id)?.classList.add("open");
    });
  });

  document.querySelectorAll("[data-modal-close]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      btn.closest(".modal")?.classList.remove("open");
    });
  });

  document.addEventListener("click", e=>{
    if (e.target.classList.contains("modal")){
      e.target.classList.remove("open");
    }
  });
}

/* ------------------------------------------------------------
   ACCORDION
------------------------------------------------------------ */
function initAccordions(){
  document.querySelectorAll(".accordion-header").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const targetId = btn.dataset.accTarget;
      const panel = document.getElementById(targetId);
      if (!panel) return;
      const isOpen = panel.classList.contains("active");
      document.querySelectorAll(".accordion-panel").forEach(p=>p.classList.remove("active"));
      if (!isOpen) panel.classList.add("active");
    });
  });
}

/* ------------------------------------------------------------
   GALLERIA NEL MODALE
------------------------------------------------------------ */
function initGalleries(){
  document.querySelectorAll(".modal").forEach(modal=>{
    const imgs = Array.from(modal.querySelectorAll(".modal-gallery-main img"));
    if (!imgs.length) return;
    let index = 0;

    const counterEl = modal.querySelector("[data-gallery-counter]");
    const controls = modal.querySelector("[data-gallery-controls]");
    if (!controls) return;

    function updateGallery(newIndex){
      if (newIndex < 0) newIndex = imgs.length - 1;
      if (newIndex >= imgs.length) newIndex = 0;
      index = newIndex;
      imgs.forEach((img,i)=>{
        img.classList.toggle("active", i === index);
      });
      if (counterEl){
        counterEl.textContent = `${index+1} / ${imgs.length}`;
      }
    }

    controls.querySelector("[data-gallery-prev]").addEventListener("click", ()=>{
      updateGallery(index - 1);
    });
    controls.querySelector("[data-gallery-next]").addEventListener("click", ()=>{
      updateGallery(index + 1);
    });
  });
}

/* ============================================================
   NAVBAR MOBILE – HAMBURGER
============================================================ */
function initNavbarToggle(){
  const body = document.body;
  const toggle = document.getElementById("nav-toggle");
  if (!toggle) return;
  toggle.addEventListener("click", ()=>{
    const isOpen = body.classList.toggle("nav-open");
    toggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
  });
}

/* ============================================================
   VIEW MODE TOGGLE (Desktop/Mobile)
============================================================ */
function setViewMode(mode){
  viewMode = mode;
  if (mode === "mobile"){
    document.body.classList.add("mobile-view");
  } else {
    document.body.classList.remove("mobile-view");
  }
  localStorage.setItem("cd_view", mode);
}

function initViewToggle(){
  const saved = localStorage.getItem("cd_view");
  if (saved === "mobile" || saved === "desktop"){
    setViewMode(saved);
  }

  const btnDesktop = document.getElementById("view-desktop");
  const btnMobile  = document.getElementById("view-mobile");

  if (btnDesktop){
    btnDesktop.addEventListener("click", ()=>{
      setViewMode("desktop");
    });
  }
  if (btnMobile){
    btnMobile.addEventListener("click", ()=>{
      setViewMode("mobile");
    });
  }
}

/* ============================================================
   INIT
============================================================ */
async function appInit(){
  currentLang = detectInitialLang();
  applyTranslations(currentLang);

  // selettore lingua
  const langSelect = document.getElementById("language-selector");
  if (langSelect){
    langSelect.value = currentLang;
    langSelect.addEventListener("change", e=>{
      setLanguage(e.target.value);
    });
  }

  // carica CSV e renderizza catalogo
  try{
    const items = await loadCsv();
    window.__catalogueData = items;
    renderCatalogue(items, currentLang);
  }catch(err){
    console.error("Errore nel caricamento del catalogo", err);
  }

  initNavbarToggle();
  initViewToggle();
}

document.addEventListener("DOMContentLoaded", appInit);

